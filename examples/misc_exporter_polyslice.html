<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - exporter - Polyslice</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>
	<body>
		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> webgl - exporter - <a href="https://github.com/jgphilpott/polyslice" target="_blank" rel="noopener">Polyslice</a>
			<br>Slice 3D models to G-code for 3D printing
			<br><a href="https://www.youtube.com/watch?v=V2h3SiafXRc" target="_blank" rel="noopener">Watch Demo Video</a>
			<br><em>Note: This example requires loading Polyslice from unpkg.com. Disable ad blockers if needed.</em>
		</div>

		<script type="importmap">
			{
				"imports": {
					"three": "../build/three.module.js",
					"three/addons/": "./jsm/"
				}
			}
		</script>

		<!-- Include Polyslice from CDN -->
		<script src="https://unpkg.com/@jgphilpott/polyslice/dist/index.browser.min.js" crossorigin="anonymous"></script>

		<script type="module">

			/* global Polyslice */

			import * as THREE from 'three';

			import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
			import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

			let camera, scene, renderer, mesh;

			const params = {
				addCube: addCube,
				addSphere: addSphere,
				addCylinder: addCylinder,
				addTorus: addTorus,
				exportToGCode: exportToGCode,
				layerHeight: 0.2,
				infillDensity: 20,
				infillPattern: 'grid'
			};

			init();

			function init() {

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.setAnimationLoop( animate );
				document.body.appendChild( renderer.domElement );

				camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.set( 0, 150, 300 );

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xa0a0a0 );

				const ambientLight = new THREE.AmbientLight( 0xffffff, 0.5 );
				scene.add( ambientLight );

				const directionalLight = new THREE.DirectionalLight( 0xffffff, 2.5 );
				directionalLight.position.set( 0, 200, 100 );
				scene.add( directionalLight );

				// Add ground plane for reference
				const gridHelper = new THREE.GridHelper( 200, 10 );
				scene.add( gridHelper );

				const gui = new GUI();

				let h = gui.addFolder( 'Geometry Selection' );
				h.add( params, 'addCube' ).name( 'Cube (10mm)' );
				h.add( params, 'addSphere' ).name( 'Sphere (10mm)' );
				h.add( params, 'addCylinder' ).name( 'Cylinder (10mm)' );
				h.add( params, 'addTorus' ).name( 'Torus' );

				h = gui.addFolder( 'Slicer Settings' );
				h.add( params, 'layerHeight', 0.1, 0.4, 0.05 ).name( 'Layer Height (mm)' );
				h.add( params, 'infillDensity', 0, 100, 5 ).name( 'Infill Density (%)' );
				h.add( params, 'infillPattern', [ 'grid', 'triangles', 'hexagons' ] ).name( 'Infill Pattern' );

				h = gui.addFolder( 'Export' );
				h.add( params, 'exportToGCode' ).name( 'Export G-code' );

				gui.open();

				// Check if Polyslice loaded successfully
				if ( typeof Polyslice !== 'undefined' ) {

					console.log( '✓ Polyslice library loaded successfully' );

				} else {

					console.warn( '✗ Polyslice library failed to load. Export will not work.' );

				}

				addCube();

				window.addEventListener( 'resize', onWindowResize );

				const controls = new OrbitControls( camera, renderer.domElement );
				controls.target.set( 0, 50, 0 );
				controls.update();

			}

			function exportToGCode() {

				if ( ! mesh ) {

					alert( 'Please add a geometry first!' );
					return;

				}

				try {

					// Check if Polyslice is loaded
					if ( typeof Polyslice === 'undefined' ) {

						alert( 'Polyslice library failed to load from CDN.\n\nPossible solutions:\n1. Disable ad blockers or browser extensions\n2. Check your network connection\n3. Ensure unpkg.com is not blocked by your firewall' );
						return;

					}

					// Create printer and filament configurations using Polyslice
					const printer = new Polyslice.Printer( 'Ender3' );
					const filament = new Polyslice.Filament( 'GenericPLA' );

					// Create the slicer instance with user-defined settings
					const slicer = new Polyslice.Polyslice( {
						printer: printer,
						filament: filament,
						layerHeight: params.layerHeight,
						infillPattern: params.infillPattern,
						infillDensity: params.infillDensity,
						verbose: false
					} );

					// Slice the mesh and generate G-code
					const gcode = slicer.slice( mesh );

					// Download the G-code file
					saveString( gcode, 'model.gcode' );

				} catch ( error ) {

					console.error( 'Error exporting to G-code:', error );
					alert( 'Error exporting to G-code. Check console for details.' );
					alert( 'Note: Polyslice is an external library. Please ensure it is loaded correctly.' );

				}

			}

			function clearScene() {

				if ( mesh ) {

					mesh.geometry.dispose();
					mesh.material.dispose();
					scene.remove( mesh );

				}

			}

			function addCube() {

				clearScene();

				const material = new THREE.MeshLambertMaterial( { color: 0x00cc00 } );
				const geometry = new THREE.BoxGeometry( 10, 10, 10 );
				mesh = new THREE.Mesh( geometry, material );
				mesh.position.y = 5; // Position on ground
				scene.add( mesh );

			}

			function addSphere() {

				clearScene();

				const material = new THREE.MeshLambertMaterial( { color: 0x00cc00 } );
				const geometry = new THREE.SphereGeometry( 5, 32, 32 );
				mesh = new THREE.Mesh( geometry, material );
				mesh.position.y = 5; // Position on ground
				scene.add( mesh );

			}

			function addCylinder() {

				clearScene();

				const material = new THREE.MeshLambertMaterial( { color: 0x00cc00 } );
				const geometry = new THREE.CylinderGeometry( 5, 5, 10, 32 );
				mesh = new THREE.Mesh( geometry, material );
				mesh.position.y = 5; // Position on ground
				scene.add( mesh );

			}

			function addTorus() {

				clearScene();

				const material = new THREE.MeshLambertMaterial( { color: 0x00cc00 } );
				const geometry = new THREE.TorusGeometry( 5, 2, 16, 100 );
				mesh = new THREE.Mesh( geometry, material );
				mesh.position.y = 5; // Position on ground
				scene.add( mesh );

			}

			const link = document.createElement( 'a' );
			link.style.display = 'none';
			document.body.appendChild( link );

			function save( blob, filename ) {

				link.href = URL.createObjectURL( blob );
				link.download = filename;
				link.click();

			}

			function saveString( text, filename ) {

				save( new Blob( [ text ], { type: 'text/plain' } ), filename );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				renderer.render( scene, camera );

			}

		</script>

	</body>
</html>
