<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<base href="../../../" />
	<script src="page.js"></script>
	<link type="text/css" rel="stylesheet" href="page.css" />
	<style>
		blockquote {
			font-size: 0.8em;
			line-height: 1.5em;
			margin-left: 0;
			border-left: 4px solid #cccccc;
			padding: 1em 2em 1em 2em;
		}

		blockquote p:first-child {
			margin-top: 0;
		}

		blockquote p:last-child {
			margin-bottom: 0;
		}

		figure {
			width: 100%;
			margin: 1em 0;
			font-style: italic;
		}

		figure img {
			width: 100%;
		}

		figure.float {
			float: right;
			max-width: 30%;
			margin: 1em;
		}

		@media all and ( max-width: 640px ) {

			figure.float {
				float: none;
				max-width: 100%;
			}

		}
	</style>
</head>

<body>
	<h1>Управление цветом ([name])</h1>

	<h2>Что такое цветовое пространство?</h2>

	<p>
	     Каждое цветовое пространство представляет собой совокупность нескольких дизайнерских
	     решений, выбранных вместе для поддержки широкого диапазон цветов и
	     при этом удовлетворять технические ограничения, связанными с точностью и отображением
	     технологий. При создании 3D-ресурса или сборке 3D-ресурсов в сцену важно знать, что это за
	     свойства и как связаны свойства одного цветового пространства к другим цветовым
	     пространствам сцены. 
	</p>

	<figure class="float">
		<img src="resources/srgb_gamut.png" alt="">
		<figcaption>
		     Цвета sRGB и точка белого (D65) показаны на эталонной диаграмме цветности CIE 1931. 
		     Цветная область представляет собой 2D-проекцию гаммы sRGB, которая представляет собой 3D-объем.
		     Источник: <a href="https://en.wikipedia.org/wiki/SRGB" target="_blank" rel="noopener">Wikipedia</a>
		</figcaption>
	</figure>

	<ul>
		<li>
			<b>Основные цвета:</b> Основные цвета (например, красный,
			   зеленый, синий) не являются абсолютными; они были выбраны
			   из видимого спектра на основе ограничений, связанных с ограниченной
			   точностью и возможностью доступных устройств отображения.
			   Цвета выражаются как соотношение основных цветов. 	
      	</li>
		<li>
			<b>Точка белого:</b> Большинство цветовых пространств
			спроектированы таким образом, что равновзвешенная			
			сумма основных элементов <i>R = G = B</i> будут бесцветными или 
			"ахроматическими". Внешний вид ахроматических значений
			(например, белого или серого) зависят от человеческого
			восприятия, которое, в свою очередь, зависит в
			значительной степени зависит от контекста наблюдателя. 
			Цветовое пространство определяет свою "точку белого", 
			чтобы сбалансировать эти потребности. Точка белого, определяемая
			цветовым пространством sRGB, равна [link:https://en.wikipedia.org/wiki/Illuminant_D65 D65]. 
		</li>
		<li>
			<b>Функции передачи:</b> После выбора цветового охвата и
			цветовой модели нам еще нужно определить отображения
			("функции передачи") числовых значений в/из цветового
			пространства. Имеет ли <i>r = 0,5</i> представляя собой на 50%
			меньше физического освещения, чем <i>r = 1,0</i>? Или на 50%
			менее яркий, как воспринимается обычным человеческим
			глазом? Это разные вещи, и эту разницу можно представить как математическую функцию.
			Передаточные функции могут быть <i>линейными</i> или <i>нелинейными</i> в зависимости от целях
			цветового пространства. sRGB определяет нелинейные передаточные функции. Т.е. функции
			иногда аппроксимируют как <i>гамма-функции</i>, но термин "гамма" неоднозначен, и его следует
			избегать в этом контексте. 
		</li>
	</ul>

	Эти три параметра — основные цвета, точка белого и передаточные функции — определяют
	цветовое пространство, и каждый из них выбирается для конкретных целей. Определив параметры
	полезно использовать несколько дополнительных терминов: 	
	
	<ul>
		<li>
			<b>Цветовая модель:</b> Синтаксис для числового определения цветов в выбранной цветовой гамме
			   — система координат для цветов. В three.js нас в основном интересует цвет RGB модели,
			   имеющая три координаты <i>r, g, b ∈ [0,1]</i> ("замкнутая область") или <i>r, g, b ∈ [0,∞]</i> ("открытая
			   область"), каждый из которых представляет собой часть первичного цвета. Другие цветовые
			   модели (HSL, Lab, LCH) обычно используются для художественного контроля.   
		</li>
		<li>
			<b>Цветовая гамма:</b> После выбора основных цветов и точки белого они представляют собой
			   объем в видимом спектре ("гамма"). Цвета за пределами этого объема ("вне гаммы") не
			   может быть выражено значениями RGB в закрытой области [0,1]. В открытой области [0,∞]
			   диапазон гаммы технически бесконечен.
		</li>
	</ul>

	<p>
		Рассмотрим два очень распространенных цветовых пространства: [page:SRGBColorSpace] ("sRGB") и 
		[page:LinearSRGBColorSpace] ("Линейный-sRGB"). Оба используют одни и те же основные цвета и
		точки белого, и, следовательно, они имеют одинаковую цветовую гамму. В обоих используется цветовая модель
		RGB. Они отличаются только передаточными функциями — Linear-sRGB линейны по отношению к 
		физической интенсивности света. sRGB использует нелинейные функции передачи sRGB и
		больше напоминает способ восприятия света человеческим глазом и чувствительности
		обычных устройств отображения. 
	</p>

	<p>  
	     Эта разница важна. Расчеты освещения и другие операции рендеринга должны обычно
	     происходить в линейном цветовом пространстве. Однако линейные цвета менее эффективны
	     для хранения в буфере изображений или кадров и выглядят некорректно при просмотре 	  
	     человеком-наблюдателем. В результате входные текстуры и окончательное визуализированное
	     изображение обычно будет использовать нелинейное цветовое пространство sRGB. 
	</p>

	<blockquote>
		<p>
			ℹ️ <i><b>ВНИМАНИЕ:</b> Хотя некоторые современные дисплеи поддерживают более широкий цветовой охват,
			      например Display-P3, графические API веб-платформы во многом полагаются на sRGB. Приложения,
			      использующие three.js. Сегодня обычно используют только цветовые пространства sRGB и Linear-
			      sRGB.</i> 
		</p>
	</blockquote>

	<h2>Роль цветовых пространств</h2>

	<p>
		Линейные рабочие процессы — необходимые для современных методов рендеринга — обычно
		включают в себя более одного цветового пространства, каждое из которых назначено на
		определенную роль. Линейные и нелинейные цветовые пространства подходят для разных
		ролей, как описано ниже.  
	</p>

	<h3>Входное цветовое пространство</h3>

	<p>
	     Цвета, поставляемые в three.js — из палитр цветов, текстур, 3D-моделей и других источников
	     — каждый из них имеет связанное цветовое пространство. Т.е., у кого еще нет рабочего цвета
	     Linear-sRGB. Пространство должно быть преобразовано, а текстурам присвоено правильное
	     назначение <i>texture.colorSpace</i>. Определенные преобразования (для шестнадцатеричных
	     цветов и цветов CSS в sRGB) могут выполняться автоматически, если API
	     THREE.ColorManagement включается перед инициализацией цветов: 
	</p>

	<code>
THREE.ColorManagement.enabled = true;
	</code>

	<p>
		THREE.ColorManagement включен по умолчанию. 
	</p>

	<ul>
		<li>
			<b>Материалы, источники света и шейдеры:</b> Цвета в материалах, источниках света и
			   оттенках сохраняют компоненты RGB в рабочем цветовом пространстве Linear-sRGB.
		</li>
		<li>
			<b>Цвета вершин:</b> [page:BufferAttribute BufferAttributes] хранят компоненты RGB в рабочем цветовом пространстве 
			Linear-sRGB.
		</li>
		<li>
			<b>Цветные текстуры:</b> PNG или JPEG [page:Texture Textures] содержащие информацию о цвете (например, 
			   .map или .emissiveMap) используют цветовое пространство sRGB с закрытым доменом и 
			   должны быть снабжены аннотацией <i>texture.colorSpace = SRGBColorSpace</i>. Такие форматы,
			   как OpenEXR (иногда используемые для .envMap или .lightMap) используют цветовое
			   пространство Linear-sRGB, указанное с помощью <i>texture.colorSpace = LinearSRGBColorSpace</i>,  
			   и может содержать значения в открытой области [0,∞]. 
		</li>
		<li>
			<b>Бесцветные текстуры:</b> Текстуры, которые не хранят информацию о цвете (например,
			   .normalMap или .roughnessMap) не имеют связанного цветового пространства и обычно
			   используют текстуру (по умолчанию) аннотацию <i>texture.colorSpace = NoColorSpace</i>. В
			   редких случаях нецветные данные по техническим причинам может быть представлен
			   другими нелинейными кодировками.
		</li>
	</ul>

	<blockquote>
		<p>
			⚠️ <i><b>ВНИМАНИЕ:</b> Многие форматы 3D-моделей работают неправильно или некорректно определяя
			      информацию о цветовом пространстве. Хотя three.js пытается справиться с большинством случаев,
			      возникают проблемы являющимися общими для старых форматов файлов. Для достижения наилучших
			      результатов используйте glTF 2.0 ( GLTFLoader ) и заранее протестируйте 3D-модели в онлайн-средствах
			      просмотра, чтобы убедиться в правильности самого ресурса.</i>
		</p>
	</blockquote>

	<h3>Рабочее цветовое пространство</h3>

	<p> 
	     Рендеринг, интерполяция и многие другие операции должны выполняться в линейном
	     рабочем цветовом пространстве, в котором компоненты RGB пропорциональны
	     физическому освещению. В three.js рабочее цветовое пространство является Linear-sRGB. 
	</p>

	<h3>Выходное цветовое пространство</h3>

	<p>
	     Вывод на устройство отображения, изображения или видео может включать преобразование
	     из открытого домена рабочее цветовое пространство Linear-sRGB в другое цветовое
	     пространство. Преобразование определяется следующим образом ([page:WebGLRenderer.outputColorSpace]).
	     Когда используешь постобработку, требуется OutputPass.
	</p>

	<ul>
		<li>
			<b>Дисплей:</b> Цвета, записанные на холст WebGL для отображения, должны находиться в 
			   цветовом пространстве в формате sRGB. 
		</li>
		<li>
			<b>Изображение:</b> Цвета, записанные в изображение, должны использовать цветовое
			   пространство, подходящее для формат и использование. Полностью визуализированные
			   изображения, обычно записанные в текстуры PNG или JPEG используя цветовое
			   пространство sRGB. Изображения, содержащие излучение, карты освещения или другие
			   данные, не ограниченный диапазоном [0,1], обычно будет использоваться открытое цветовое
			   пространство Linear-sRGB, и совместимый формат изображения, такой как OpenEXR.
		</li>
	</ul>

	<blockquote>
		<p>
			⚠️ <i><b>ВНИМАНИЕ:</b> Цели рендеринга могут использовать либо sRGB, либо Linear-sRGB. sRGB делает лучшее
			         использование ограниченной точности. В закрытой области для sRGB часто достаточно 8 бит. Тогда как
			         для Linear-sRGB может потребоваться ≥12 бит (полуплавающее число).Если для ступеней водопровода требуется 
			         линейный ввод данных в формате sRGB, дополнительные преобразования могут иметь небольшую стоимость
			         на производительность.</i> 
		</p>
	</blockquote>

	<p>
		Пользовательские материалы на основе [page:ShaderMaterial] и [page:RawShaderMaterial] должны
		реализовывать собственное преобразование выходного цветового пространства. Для случаев 
		`ShaderMaterial`, добавив `colorspace_fragment` фрагмент шейдера во фрагментный шейдер 
		`main()` функции должно быть достаточно. 
	</p>

	<h2>Работа с экземплярами THREE.Color</h2>

	<p>
		Методы чтения или изменения экземпляров [page:Color] предполагают, что данные уже находятся в 
		рабочем цветовом пространстве three.js, Linear-sRGB. RGB и HSL компоненты являются
		прямыми представления данных, хранящихся экземпляром Color, и никогда не преобразуются 
		неявно. Цветовые данные могут быть явно преобразованы с помощью <i>.convertLinearToSRGB()</i>
		или <i>.convertSRGBToLinear()</i>.
	</p>

	<code>
		// RGB компоненты (без изменений).
		color.r = color.g = color.b = 0.5;
		console.log( color.r ); // → 0.5

		// Ручное преобразование.
		color.r = 0.5;
		color.convertSRGBToLinear();
		console.log( color.r ); // → 0.214041140
	</code>

	<p>
		Если <i>ColorManagement.enabled = true</i> установлено (рекомендуется), то некоторые преобразования 
		производятся автоматически. Поскольку шестнадцатеричные цвета и цвета CSS обычно имеют 
		формат sRGB, [page:Color] методы автоматически преобразуют эти входные данные из sRGB в Linear-
		sRGB в установщиках или конвертируют из Linear-sRGB в sRGB при возврате 
		шестнадцатеричного или CSS-вывода из геттеров. 
	</p>

	<code>
		// Шестнадцатеричное преобразование.
		color.setHex( 0x808080 );
		console.log( color.r ); // → 0.214041140
		console.log( color.getHex() ); // → 0x808080

		// CSS преобразование.
		color.setStyle( 'rgb( 0.5, 0.5, 0.5 )' );
		console.log( color.r ); // → 0.214041140

		// Переопределить преобразование с помощью аргумента 'colorSpace'.
		color.setHex( 0x808080, LinearSRGBColorSpace );
		console.log( color.r ); // → 0.5
		console.log( color.getHex( LinearSRGBColorSpace ) ); // → 0x808080
		console.log( color.getHex( SRGBColorSpace ) ); // → 0xBCBCBC
	</code>

	<h2>Распространенные ошибки</h2>

	<p>
           Если отдельный цвет или текстура настроены неправильно, они будут выглядеть темнее или
           светлее, чем ожидалось. Если выходное цветовое пространство средства визуализации настроено
           неправильно, вся сцена может отображаться темнее (например, отсутствует преобразование в
           sRGB) или светлее (например, двойное преобразование в sRGB с постобработкой). В каждом 
           конкретном случае проблема может быть неоднородной, и простое увеличение/уменьшение освещенности
           её не решит эту проблему. 	
     	</p>

	<p> 
	     Более тонкая проблема возникает, когда <i>оба</i> цветовых пространства, входные и выходные цветовые
	     пространства выбраны неправильно — общий уровень яркости может быть в порядке, но цвета могут измениться
	     неожиданно при разном освещении или затенении может показаться более размытым и менее
	     мягким, чем предполагалось. Эти две ошибки не являются правильными, и важно, чтобы
	     работающие цветовое пространство должно быть линейным ("относится к сцене"), а выходное
	     цветовое пространство быть нелинейным ("относится к дисплею"). 
	</p>

	<h2>Дальнейшее чтение</h2>

	<ul>
		<li>
			<a href="https://developer.nvidia.com/gpugems/gpugems3/part-iv-image-effects/chapter-24-importance-being-linear" target="_blank" rel="noopener">GPU Gems 3: The Importance of Being Linear</a> от Larry Gritz и Eugene d'Eon
		</li>
		<li>
			<a href="https://blog.johnnovak.net/2016/09/21/what-every-coder-should-know-about-gamma/" target="_blank" rel="noopener">What every coder should know about gamma</a> от John Novak
		</li>
		<li>
			<a href="https://hg2dc.com/" target="_blank" rel="noopener">The Hitchhiker's Guide to Digital Color</a> от Troy Sobotka
		</li>
		<li>
			<a href="https://docs.blender.org/manual/en/latest/render/color_management.html" target="_blank" rel="noopener">Color Management</a> Blender
		</li>
	</ul>

</body>

</html>
